---
# GitHub Actions workflow to run MegaLinter on all non-archived repositories
# Fetches all user's non-archived GitHub repositories, clones them into a
# single directory, and runs MegaLinter once on the entire directory
# https://megalinter.io/
name: mega-linter-all-repos

on:
  workflow_dispatch:
    inputs:
      megalinter_flavor:
        type: choice
        description: MegaLinter flavor to use
        default: all
        options:
          - all
          - cupcake
          - documentation
          - dotnet
          - dotnetweb
          - go
          - java
          - javascript
          - php
          - python
          - ruby
          - rust
          - salesforce
          - security
          - swift
          - terraform

permissions: read-all

defaults:
  run:
    shell: bash -euo pipefail {0}

jobs:
  megalinter:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ secrets.MY_RENOVATE_GITHUB_APP_ID }}
          private-key: ${{ secrets.MY_RENOVATE_GITHUB_PRIVATE_KEY }}

      - name: Fetch and clone all non-archived repositories
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          echo "Fetching non-archived repositories for user: ${REPO_OWNER}"

          # Fetch all non-archived, non-empty repositories using GitHub CLI
          repos=$(gh repo list "${REPO_OWNER}" --no-archived --source --limit 1000 --json nameWithOwner,isEmpty \
            --jq '[.[] | select(.isEmpty == false) | .nameWithOwner]')

          repo_count=$(echo "${repos}" | jq 'length')
          echo "Found ${repo_count} non-archived, non-empty repositories"

          # Create repos directory
          mkdir -p repos

          # Clone each repository
          echo "${repos}" | jq -r '.[]' | while read -r repo; do
            echo "Cloning ${repo}..."
            repo_name="${repo#*/}"
            gh repo clone "${repo}" "repos/${repo_name}" -- --depth 1 --single-branch
          done

          echo ""
          echo "=== Cloned repositories ==="
          ls -la repos/

          # Save repo count for summary
          echo "${repo_count}" > repo_count.txt

      - name: ðŸ’¡ MegaLinter
        uses: oxsecurity/megalinter@42bb470545e359597e7f12156947c436e4e3fb9a # v9.3.0
        env:
          DEFAULT_WORKSPACE: repos
          GITHUB_COMMENT_REPORTER: false
          GITHUB_STATUS_REPORTER: false
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          MEGALINTER_FLAVOR: ${{ inputs.megalinter_flavor || 'all' }}
          VALIDATE_ALL_CODEBASE: true

      - name: Upload MegaLinter artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: megalinter-reports
          path: |
            megalinter-reports
          retention-days: 1

      - name: Generate summary
        if: always()
        run: |
          repo_count=$(cat repo_count.txt 2>/dev/null || echo "unknown")
          {
            echo "## MegaLinter All Repos Summary"
            echo ""
            echo "- **Total repositories processed**: ${repo_count}"
            echo "- **MegaLinter flavor**: ${{ inputs.megalinter_flavor || 'all' }}"
            echo ""
            echo "Check the uploaded artifacts for detailed linting reports."
          } >> "${GITHUB_STEP_SUMMARY}"
