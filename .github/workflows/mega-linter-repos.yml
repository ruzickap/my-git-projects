---
# GitHub Actions workflow to run MegaLinter on all public repositories
# with .mega-linter.yml configuration file
# https://megalinter.io/
name: mega-linter-all-repos

on:
  workflow_dispatch:
    inputs:
      repository:
        type: string
        description: Specific repository name to scan (my-git-projects). Leave empty to scan all repos
        default: ""
      megalinter_flavor:
        type: choice
        description: MegaLinter flavor to use
        default: all
        options:
          - all
          - cupcake
          - documentation
          - dotnet
          - dotnetweb
          - go
          - java
          - javascript
          - php
          - python
          - ruby
          - rust
          - salesforce
          - security
          - swift
          - terraform

permissions: read-all

env:
  REPO_OWNER: ${{ github.repository_owner }}

defaults:
  run:
    shell: bash -euo pipefail {0}

jobs:
  fetch-repos:
    runs-on: ubuntu-24.04-arm
    outputs:
      repos: ${{ steps.get-repos.outputs.repos }}
    steps:
      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ secrets.MY_RENOVATE_GITHUB_APP_ID }}
          private-key: ${{ secrets.MY_RENOVATE_GITHUB_PRIVATE_KEY }}

      - name: Get repository list
        id: get-repos
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          INPUT_REPOSITORY: ${{ inputs.repository }}
        run: |
          if [[ -n "${INPUT_REPOSITORY}" ]]; then
            # Scan specific repository
            REPOS="[\"${INPUT_REPOSITORY}\"]"
            echo "Scanning specific repository: ${REPO_OWNER}/${INPUT_REPOSITORY}"
          else
            # Get all public, non-archived repos with .mega-linter.yml
            ALL_REPOS=$(gh repo list "${REPO_OWNER}" --no-archived --visibility public \
              --source --limit 1000 --json name --jq '[.[].name]')
            REPOS="[]"
            for NAME in $(echo "${ALL_REPOS}" | jq -r '.[]'); do
              if gh api "repos/${REPO_OWNER}/${NAME}/contents/.mega-linter.yml" --silent 2>/dev/null; then
                REPOS=$(echo "${REPOS}" | jq --arg name "${NAME}" '. + [$name]')
              fi
            done
            echo "Found $(echo "${REPOS}" | jq 'length') repositories with .mega-linter.yml"
          fi
          echo "repos=$(echo "${REPOS}" | jq -c '.')" >> "${GITHUB_OUTPUT}"

  megalinter-parallel:
    needs: fetch-repos
    runs-on: ubuntu-latest
    name: "megalinter-${{ inputs.megalinter_flavor || 'all' }}-${{ matrix.repo }}"
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.fetch-repos.outputs.repos) }}
    steps:
      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ secrets.MY_RENOVATE_GITHUB_APP_ID }}
          private-key: ${{ secrets.MY_RENOVATE_GITHUB_PRIVATE_KEY }}

      - name: Checkout ${{ matrix.repo }}
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ env.REPO_OWNER }}/${{ matrix.repo }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 1

      - name: ðŸ’¡ MegaLinter
        uses: oxsecurity/megalinter@42bb470545e359597e7f12156947c436e4e3fb9a # v9.3.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
          MEGALINTER_FLAVOR: ${{ inputs.megalinter_flavor || 'all' }}
          VALIDATE_ALL_CODEBASE: true
