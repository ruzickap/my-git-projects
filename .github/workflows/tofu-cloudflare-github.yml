---
# GitHub Actions workflow for OpenTofu infrastructure provisioning
# Manages Cloudflare and GitHub resources via Infrastructure as Code
name: tofu-cloudflare-github

on:
  pull_request:
    types: [opened, reopened, synchronize, labeled]
    paths:
      - opentofu/cloudflare-github/**
      - "!opentofu/cloudflare-github/README.md"
  push:
    branches: [main]
    paths:
      - opentofu/cloudflare-github/**
      - "!opentofu/cloudflare-github/README.md"
  schedule:
    - cron: "0 0 * * 1"

permissions: read-all

env:
  # keep-sorted start
  AWS_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}
  AWS_S3_ENDPOINT: ${{ secrets.CLOUDFLARE_R2_ENDPOINT_URL_S3 }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}
  OPENTOFU_CLOUDFLARE_GITHUB_API_TOKEN_NAME: "opentofu-cloudflare-github (ruzickap/my-git-projects/opentofu/cloudflare-github)"
  OPENTOFU_CLOUDFLARE_GITHUB_API_TOKEN: ${{ secrets.OPENTOFU_CLOUDFLARE_GITHUB_API_TOKEN }}
  SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
  TF_VAR_gh_token_opentofu_cloudflare_github: ${{ secrets.TF_VAR_GH_TOKEN_OPENTOFU_CLOUDFLARE_GITHUB }}
  TF_VAR_opentofu_encryption_passphrase: ${{ secrets.TF_VAR_OPENTOFU_ENCRYPTION_PASSPHRASE }}
  # keep-sorted end

jobs:
  tofu-cloudflare-github:
    runs-on: ubuntu-24.04-arm
    permissions:
      actions: read # Required to identify workflow run.
      checks: write # Required to add status summary.
      contents: read # Required to checkout repository.
      issues: write # Required to open issue on drift.
      pull-requests: write # Required to add PR comment.
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Remove tofu labels from PR
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit "${{ github.event.pull_request.number }}" --remove-label tofu-apply --remove-label tofu-plan

      - uses: opentofu/setup-opentofu@e95ccdd20623115bfd7d47df14a3250d6066a9d0 # v1.0.7
        with:
          tofu_wrapper: false

      - uses: op5dev/tf-via-pr@5a4229041e3c90818d85813d4e4a4d44f653d5e9 # v13.7.2
        id: tofu
        with:
          arg-lock: ${{ github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'tofu-apply') }}
          command: ${{ (github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'tofu-apply')) && 'apply' || 'plan' }}
          comment-pr: ${{ github.event_name == 'schedule' && 'never' || 'always' }}
          expand-diff: true
          plan-encrypt: ${{ secrets.TF_VAR_OPENTOFU_ENCRYPTION_PASSPHRASE }}
          retention-days: 7
          tool: tofu
          working-directory: opentofu/cloudflare-github

      - name: Open issue on drift
        if: github.event_name == 'schedule' && steps.tofu.outputs.exitcode != 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOFU_OUTPUTS_DIFF: ${{ steps.tofu.outputs.diff }}
          TOFU_OUTPUTS_RUN: ${{ steps.tofu.outputs.run-url }}
          TOFU_OUTPUTS_RESULT: ${{ steps.tofu.outputs.result }}
          TOFU_OUTPUTS_SUMMARY: ${{ steps.tofu.outputs.summary }}
        run: |
          gh api "/repos/{owner}/{repo}/issues" \
            --method POST \
            --field title="Configuration drift detected" \
            --field body="[View log.](${TOFU_OUTPUTS_RUN})
          <details><summary>Diff of changes.</summary>

          \`\`\`diff
          ${TOFU_OUTPUTS_DIFF}
          \`\`\`
          </details>
          <details><summary>$summary</summary>

          \`\`\`hcl
          ${TOFU_OUTPUTS_RESULT}
          \`\`\`
          </details>"
