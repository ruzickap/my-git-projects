---
# GitHub Actions workflow for OpenTofu infrastructure provisioning
# Manages Cloudflare and GitHub resources via Infrastructure as Code
name: tofu-cloudflare-github

on:
  pull_request:
  push:
    branches: [main]

permissions: read-all

env:
  # keep-sorted start
  AWS_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}
  AWS_S3_ENDPOINT: ${{ secrets.CLOUDFLARE_R2_ENDPOINT_URL_S3 }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}
  OPENTOFU_CLOUDFLARE_GITHUB_API_TOKEN_NAME: "opentofu-cloudflare-github (ruzickap/my-git-projects/opentofu/cloudflare-github)"
  OPENTOFU_CLOUDFLARE_GITHUB_API_TOKEN: ${{ secrets.OPENTOFU_CLOUDFLARE_GITHUB_API_TOKEN }}
  SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
  TF_VAR_gh_token_opentofu_cloudflare_github: ${{ secrets.TF_VAR_GH_TOKEN_OPENTOFU_CLOUDFLARE_GITHUB }}
  TF_VAR_opentofu_encryption_passphrase: ${{ secrets.TF_VAR_OPENTOFU_ENCRYPTION_PASSPHRASE }}
  # keep-sorted end

jobs:
  provision:
    runs-on: ubuntu-24.04-arm
    permissions:
      actions: read # Required to identify workflow run.
      checks: write # Required to add status summary.
      contents: read # Required to checkout repository.
      pull-requests: write # Required to add PR comment.
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: opentofu/setup-opentofu@000eeb8522f0572907c393e8151076c205fdba1b # v1
        with:
          tofu_wrapper: false

      # Run plan by default, or apply on merge.
      - uses: op5dev/tf-via-pr@5a4229041e3c90818d85813d4e4a4d44f653d5e9 # v13.7.2
        with:
          working-directory: opentofu/cloudflare-github
          tool: tofu
          command: ${{ github.event_name == 'push' && 'apply' || 'plan' }}
          arg-lock: ${{ github.event_name == 'push' }}
          plan-encrypt: ${{ secrets.TF_VAR_OPENTOFU_ENCRYPTION_PASSPHRASE }}
          retention-days: 7
